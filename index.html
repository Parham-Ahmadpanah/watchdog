<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anti‑Theft Guardian v2.0</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Secure your laptop with Anti‑Theft Guardian v2.0. Buy a license in one click!">
  <style>
    body {
      margin: 0; font-family: 'Segoe UI', Arial, sans-serif;
      background: #f7faff; color: #111;
    }
    .container {
      max-width: 450px; margin: 3rem auto 0; background: #fff;
      border-radius: 10px; box-shadow: 0 6px 30px #2222  ;
      padding: 2.2rem 2.5rem;
    }
    h1, h2 { text-align:center; margin:0 0 1.5rem }
    .btn {
        display: inline-block;
        background: #0078d7; color: #fff; border: 0; border-radius: 4px;
        font: bold 1rem 'Segoe UI',Arial,sans-serif; padding: 0.8rem 2.2rem;
        margin: 2rem auto 1rem;   cursor:pointer; box-shadow: 0 2px 8px #0078d733;
        transition: background 0.12s;
    }
    .btn:hover { background: #005ea5; }
    .hidden { display:none!important; }
    .field { margin-bottom: 1.5rem;}
    label { display:block; font-weight:500; margin-bottom: 0.4em;}
    input[type="email"], input[type="text"] {
      width: 100%; padding: 0.7em; font-size:1rem; border: 1px solid #ccc; border-radius:4px;
    }
    .msg { font-size: 1rem; color: #06a900; margin: 1rem 0;}
    .err { color:#db003f;}
    #paypal-button-container { margin-top:2rem; }
    #logout { float: right; background: #eee; color:#333; margin-top:-1.4rem; margin-bottom:0.5rem; }
    .feature-list { padding:0; list-style:none;}
    .feature-list li:before { content:'✓ '; color:#0078d7; }
    .feature-list li { margin-bottom:0.7rem; }
    .purchase-state { font-size:1.1rem; padding:1em 0.5em; }
    .activation-group { margin:1.3rem 0 0.5rem }
    .copy-btn { margin-left:0.6em; font-size:1rem; }
    footer {
      text-align: center; margin:2.5rem 0 0; font-size:.9rem; color:#888;
    }
    @media(max-width: 600px) {
      .container { padding: 1.3rem 0.7rem;}
    }
  </style>
  <!-- PayPal Smart Buttons -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID"></script>
</head>
<body>
  <div class="container">
    <!-- PAGE 1: LANDING -->
    <section id="sec-landing">
      <h1>Anti‑Theft Guardian <span style="font-size:1.1em">v2.0</span></h1>
      <h2>Protect your laptop everywhere.</h2>
      <ul class="feature-list">
        <li>Alarms instantly if unplugged while protected</li>
        <li>Shuts down forced power-off attempts</li>
        <li>One-device lifetime license, secure activation</li>
        <li>Works on Windows 10/11</li>
      </ul>
      <button class="btn" onclick="goToLogin()">Get Started</button>
    </section>

    <!-- PAGE 2: LOGIN -->
    <section id="sec-login" class="hidden">
      <h2>Sign In to Purchase</h2>
      <form id="login-form" onsubmit="event.preventDefault();onLogin()">
        <div class="field">
          <label for="email">Email address for activation</label>
          <input id="email" type="email" placeholder="you@email.com" required autocomplete="email" />
        </div>
        <button class="btn" type="submit">Continue</button>
        <p style="font-size:.95em;color:#888;margin-top:1em;">We never share your email. Activation code is sent here.</p>
      </form>
    </section>

    <!-- PAGE 3: USER PANEL -->
    <section id="sec-panel" class="hidden">
      <button id="logout" onclick="doLogout()" title="Sign out">⎋ Logout</button>
      <h2>Welcome, <span id="user-email"></span></h2>
      <div id="purchase-view">
        <div id="purchase-status" class="purchase-state"></div>
        <!-- PayPal & Activation views will be inserted here -->
      </div>
    </section>
  </div>

  <footer>
    © 2025 Parham Panah &bull; <a href="https://parhampanah.com">Main Site</a> &bull;
    Support: <a href="mailto:support@parhampanah.com">support@parhampanah.com</a>
  </footer>

  <!-- Core SPA Script -->
  <script>
    // ===== SPA Navigation/Helpers =====
    const $ = s=>document.querySelector(s);

    function show(sec) {
      ["#sec-landing","#sec-login","#sec-panel"]
        .forEach(id=>$(id).classList.add("hidden"));
      $(sec).classList.remove("hidden");
    }
    function goToLogin() { show('#sec-login'); }
    function goToPanel() { show('#sec-panel'); loadPanel(); }

    // ===== Simple Auth State =====
    function userEmail() {
      return window.localStorage && localStorage.getItem('antitheft_email');
    }
    function setUser(e) {
      window.localStorage && localStorage.setItem('antitheft_email',e);
    }
    function clearUser() {
      window.localStorage && localStorage.removeItem('antitheft_email');
    }

    // On page load: state check
    window.onload = function() {
      let email = userEmail();
      if (email) { goToPanel(); }
      else { show("#sec-landing"); }
    };

    // ========== LOGIN FORM ==========
    function onLogin() {
      let email = $("#email").value.trim().toLowerCase();
      if (!email) return;
      setUser(email);
      goToPanel();
    }
    function doLogout() {
      clearUser();
      location.reload();
    }

    // ========== PANEL LOGIC ==========
    function loadPanel() {
      let email = userEmail();
      $("#user-email").innerText = email;
      let statusDiv = $("#purchase-status");
      statusDiv.innerHTML = `<span>Loading your license status…</span>`;

      // Fetch license state from backend
      fetch(`https://watchdog.parhampanah.com/verify/${encodeURIComponent(email)}`)
        .then(r=>r.json())
        .then(data=>{
          if (data.status === 'licensed' && data.code) {
            // Already purchased
            statusDiv.innerHTML = `
              <span class="msg">✅ License Activated!</span>
              <div class="activation-group">
                <b>Your Activation Code:</b><br>
                <input id="codebox" value="${data.code}" readonly style="font-size:1em;width:80%;margin-top:0.3em;">
                <button class="copy-btn" onclick="navigator.clipboard.writeText('${data.code}')">Copy</button>
              </div>
              <div style="margin-top:1em;color:#888;font-size:.95em;">
                Use this activation code in the app on your device.<br>
                <br>
                Need help? <a href="mailto:support@parhampanah.com">Contact support</a>
              </div>
            `;
          } else {
            // Not purchased: show buy now and allow code input
            statusDiv.innerHTML = `
              <span class="err">⚠️ No license detected for this email.</span>
              <div style="margin:1.5rem 0;text-align:center;">
                <div id="paypal-button-container"></div>
              </div>
              <div class="activation-group">
                <b>Already have an activation code?</b><br>
                <input id="manual-code" type="text" placeholder="Paste your code here" style="width:70%;">
                <button class="copy-btn" onclick="submitManualCode()">Activate</button>
              </div>
            `;
            renderPayPalButton(email);
          }
        })
        .catch(err=>{
          statusDiv.innerHTML = `<span class="err">Could not connect to server.<br>Please try again later.</span>`;
        });
    }

    // ========== PayPal Integration ==========
    function renderPayPalButton(email) {
      // Remove any previous buttons to avoid PayPal loader issues!
      let c = document.getElementById("paypal-button-container");
      c.innerHTML = '';
      paypal.Buttons({
        style: { shape: "pill", color: "blue", label: "paypal" },
        createOrder: function(data, actions) {
          return actions.order.create({
            intent: 'CAPTURE',
            purchase_units: [{
              description: "Anti‑Theft Guardian 2.0 License",
              amount: { currency_code: "USD", value: "14.99" }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            // Notify backend, send email/code
            fetch("https://watchdog.parhampanah.com/payment-success", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: email,
                order_id: data.orderID,
                payer_email: details.payer.email_address,
                payer_name: details.payer.name.given_name
              })
            })
            .then(x => x.json())
            .then(res => {
              alert("✅ Thank you! Your purchase was successful. Check your email for your activation code.");
              loadPanel();
            })
            .catch(err => {
              alert("Payment succeeded, but there was a server error. Forward your PayPal receipt to support@parhampanah.com.");
            });
          });
        },
        onError: function (err) {
          alert("❌ Payment failed. Please retry or contact support.");
        }
      }).render("#paypal-button-container");
    }

    // ========== MANUAL CODE ACTIVATION ==========
    function submitManualCode() {
      let code = $("#manual-code").value.trim();
      let email = userEmail();
      if (!code) { alert('Please paste your activation code.'); return;}
      // Call backend to verify code for this email
      fetch("https://watchdog.parhampanah.com/verify-code", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ email: email, code: code })
      })
      .then(r=>r.json())
      .then(data=>{
        if (data.ok) {
          alert("✅ Activation complete! Your license is now active.");
          loadPanel();
        } else {
          alert("Invalid code, please check and try again. If you continue to have issues, contact support.");
        }
      })
      .catch(err=>{
        alert("Error connecting to activation server.");
      });
    }
  </script>
</body>
</html>
